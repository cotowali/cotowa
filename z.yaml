default: run
disable_help: true
tasks:
  run.debug: v -cg run cmd/ric/main.v $@
  run: v run cmd/ric/main.v $@
  run.trace.parser: v -d trace_parser run cmd/ric/main.v $@
  run.bin: ./.bin/ric $@
  fib: z run examples/fib.ri
  build: mkdir -p .bin && v cmd/ric/main.v -o .bin/ric
  build.c: v cmd/ric/main.v -o main.c
  symlink: ln -fs $(pwd)/.bin/ric /usr/local/bin/ric
  test: |
    if [ "$#" -eq "0" ]
    then
      z test.unit
      z test.integration
    else
      for f in "$@"
      do
        if [ "$(dirname "$f")" = 'tests' ] || [ "$(basename "$f")" = 'tests' ]
        then
          z test.integration $f
        else
          z test.unit $f
        fi
      done
    fi
  test.unit: v test ${@:-./cotowari}
  test.integration: v run tests/run.v $@
  test.fix: v -d fix run tests/run.v $@
  test.hello: z run examples/hello.ri
  fmt: v fmt -w .
  fmt.c: z fmt && z test && git add . && git commit -m 'fmt'
  ast: z run tools ast $@
  tokens: z run tools tokens $@
  scope: z run tools scope $@

  publish:
    tasks:
      docker:
        - docker compose --env-file ./docker/push.env build
        - docker compose --env-file ./docker/push.env push
  ci:
    tasks:
      setup-v: cd /tmp && git clone --depth=1 https://github.com/vlang/v && cd v && make && pwd >> $GITHUB_PATH
      format: v fmt -verify .
      test: z test
