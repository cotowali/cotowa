default: run
disable_help: true
var:
  ric_path: cmd/ric
  hello_world: examples/hello_world.ri
tasks:
  run: v run {{ric_path}} $@
  no-emit: v run {{ric_path}} --no-emit $@
  debug: v -cg run {{ric_path}} $@
  watch: v watch --add $@ run {{ric_path}} $@
  profile: v -profile profile.txt run {{ric_path}} $@
  trace:
    tasks:
      lexer: v -cg -d trace_lexer run {{ric_path}} --no-emit $@
      parser: v -cg -d trace_parser run {{ric_path}} --no-emit $@
      resolver: v -cg -d trace_resolver run {{ric_path}} --no-emit $@
  time: |
    /usr/bin/time -f 'Time: %es, Memory: %M: KB ' v run {{ric_path}}

  build.c: v {{ric_path}} -o main.c

  build: mkdir -p .bin && v {{ric_path}} -o .bin/ric
  symlink: ln -fs $(pwd)/.bin/ric /usr/local/bin/ric
  install: z build && cp $(pwd)/.bin/ric /usr/local/bin/ric

  ast: z run tools ast $@
  tokens: z run tools tokens $@
  scope: z run tools scope $@

  fix:
    - z fmt
    - z test.fix

  test:
    run: |
      if [ "$#" -eq "0" ]
      then
        z test.unit
        z test.integration
      else
        for f in "$@"
        do
          if echo $f | grep '_test.v$' > /dev/null
          then
            z test.unit $f
          else
            z test.integration $f
          fi
        done
      fi
    tasks:
      unit: v test ${@:-./cotowari}
      integration: v run tests/run.v $@
      fix: v -d fix run tests/run.v $@
      hello: z run examples/hello.ri

  fmt: v fmt -w .
  fmt.c: z fmt && z test && git add . && git commit -m 'fmt'

  publish:
    run: z publish.docker
    tasks:
      docker:
        - docker compose --env-file ./docker/push.env build
        - docker compose --env-file ./docker/push.env push
  ci:
    tasks:
      setup-v: cd /tmp && git clone --depth=1 https://github.com/vlang/v && cd v && make && pwd >> $GITHUB_PATH
      format: v fmt -verify .
      test: z test
      run-on-all-conditions:
        - z {{hello_world}}
        - z trace lexer {{hello_world}}
        - z trace parser {{hello_world}}
        - z trace resolver {{hello_world}}
        - z fix
