default: default
disable_help: true
var:
  bin: $(pwd)/.bin
  install_dir: /usr/local/bin
  lic_path: cmd/lic
  kuqi_path: cmd/kuqi
  hello_world: examples/hello_world.li
  err_source: tests/expr_err.li
  format_sources: cmd/lic cmd/tools jsonrpc lsp cotowali kuqi
tasks:
  default: |
    if [ "$#" -eq 0 ]
    then
      z build
      z kuqi build
    else
      z run $@
    fi

  run: v run {{lic_path}} ${@:- {{hello_world}} }
  run.stdin: v run {{lic_path}}
  no-emit: v run {{lic_path}} -no-emit $@
  debug: v -cg -g run {{lic_path}} $@
  watch: v watch --add $@ run {{lic_path}} $@
  profile: v -profile profile.txt run {{lic_path}} $@
  trace:
    tasks:
      lexer: v -cg -d trace_lexer run {{lic_path}} -no-emit $@
      parser: v -cg -d trace_parser run {{lic_path}} -no-emit $@
      resolver: v -cg -d trace_resolver run {{lic_path}} -no-emit $@
      checker: v -cg -d trace_checker run {{lic_path}} -no-emit $@
  time: |
    /usr/bin/time -f 'Time: %es, Memory: %M: KB ' v run {{lic_path}}

  build.c: v {{lic_path}} -o main.c

  build: mkdir -p {{bin}} && v {{lic_path}} -o {{bin}}/lic
  build.win: mkdir -p {{bin}} && v {{lic_path}} -o {{bin}}/lic.exe -os windows
  symlink: ln -fs {{bin}}/lic {{install_dir}}/lic
  install: z build && cp {{bin}}/lic {{install_dir}}/lic

  kuqi:
    run: z kuqi build
    tasks:
      run: v run {{kuqi_path}} $@
      build: v {{kuqi_path}} -o {{bin}}/kuqi $@
      build.gc: v {{kuqi_path}} -o {{bin}}/kuqi -gc boehm $@
      build.win: v {{kuqi_path}} -o {{bin}}/kuqi.exe -os windows $@
      symlink: sudo ln -fs {{bin}}/kuqi {{install_dir}}/kuqi

  ast: z run tools ast $@
  tokens: z run tools tokens $@
  scope: z run tools scope $@

  fix:
    - z fmt

  test:
    run: |
      if [ "$#" -eq "0" ]
      then
        z test.unit
        z test.integration
      else
        for f in "$@"
        do
          if echo $f | grep -e '_test.v$' -e '^cotowali' > /dev/null
          then
            z test.unit $f
          else
            z test.integration $f
          fi
        done
      fi
    tasks:
      unit: v test ${@:-./cotowali}
      integration: v run tests/run.v $@
      fix: z test integration --fix $@
      hello: z run examples/hello.li
      watch: |
        watch=""
        for f in "$@"
        do
          watch="$watch -w $f"
        done
        watch="${watch:- -e li}"
        watchexec -r $watch z test $@

  fmt: v fmt -w {{format_sources}}
  fmt.c: z fmt && z test && git add . && git commit -m 'fmt'

  publish:
    run: z publish.docker
    tasks:
      docker:
        - docker compose --env-file ./docker/push.env build
        - docker compose --env-file ./docker/push.env push
  release:
    tasks:
      monthly: |
        date="$(date +%Y.%m)"
        tag="monthly.$date"
        git tag -s "$tag" -m "Monthly release: $date"
        git push origin "$tag"
  ci:
    tasks:
      setup-v: cd /tmp && git clone --depth=1 https://github.com/vlang/v && cd v && make && pwd >> $GITHUB_PATH
      format: v fmt -verify {{format_sources}}
      test: z test
      test.shellcheck: z test --shellcheck
      run-on-all-conditions:
        - z {{hello_world}}
        - z ast {{hello_world}}
        - z ast {{err_source}}
        - z tokens {{hello_world}}
        - z tokens {{err_source}}
        - z scope {{hello_world}}
        - z scope {{err_source}}
        - z trace lexer {{hello_world}}
        - z trace parser {{hello_world}}
        - z trace resolver {{hello_world}}
        - z fix
